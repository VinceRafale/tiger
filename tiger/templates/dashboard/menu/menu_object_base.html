{% extends 'dashboard/restaurant/home.html' %}

{% block body-class %}{{ block.super }}menu{% endblock %}

{% block extrahead %}
<style>
input.error {background-color:pink;}
</style>
{% endblock %}

{% block content %}

<div>
    {% block object_section %}
        {% if object %}
        <a href="{% url dashboard_edit_menu type,object.id %}">Edit</a>
        {% endif %}
        {% block object_info %}
        <h2>{{ object.name }}</h2>
        <p>{{ object.description|linebreaks }}</p>
        {% endblock %}
    {% endblock %}
</div>

<div id="price-points">
    {% block pricepoints %}
        <h3>Price points</h3>
        <ul>
            {% for obj in object.variant_set.all %}
            {% include 'dashboard/menu/includes/variant_row.html' %}
            {% empty %}
            <li class="empty">You have not defined any price points for this {{ type }}.</li>
            {% endfor %}
        </ul>
        <a class="add" href="#" rel="{% url add_pricepoint type,object.id %}">Add</a>
    {% endblock %}
</div>

<div>
    {% block sides %}
        <h3>Side dish choices</h3>
        <ul>
            {% for group in object.sidedishgroup_set.all %}
            <li>{{ group }} (<a href="{% url add_side group.id %}">Add choice</a> / <a href="{% url delete_sidegroup group.id %}">Delete</a>)
                <ul>
                    {% for side in group.sidedish_set.all %}
                    <li>{{ side }} (<a href="{% url edit_side side.id %}">Edit</a> / <a href="{% url side side.id %}">Delete</a>)</li>
                    {% empty %}
                    <li class="empty">No choices defined.</li>
                    {% endfor %}
                </ul>
            </li>
            {% empty %}
            <li class="empty">You have not defined any side dish choices for this {{ type }}.</li>
            {% endfor %}
        </ul>
        <a href="{% url add_sidegroup type,object.id %}">Add</a>
    {% endblock %}
</div>

<div id="extras">
    {% block extras %}
        <h3>Extras</h3>
        <ul>
            {% for obj in object.upgrade_set.all %}
            {% include 'dashboard/menu/includes/upgrade_row.html' %}
            {% empty %}
            <li class="empty">You have not defined any extras for this {{ type }}.</li>
            {% endfor %}
        </ul>
        <a class="add" href="#" rel="{% url add_extra type,object.id %}">Add</a>
    {% endblock %}
</div>

<div class="clear"></div>
{% endblock %}

{% block js %}
<script type="text/javascript">

// provides lists of names for form inputs
var formSnippets = {
    'price-points': ["description", "price"],
    'extras': ["name", "price"]
};

function getForm(addAnchor) {
    if (arguments.length == 2) {
        initial = arguments[1];
    } else {
        initial = {};
    }
    inputs = formSnippets[$(addAnchor).closest("div").attr("id")];
    fakeForm = '<li class="form">';
    $.each(inputs, function () {
        titleCase = this[0].toUpperCase() + this.slice(1);
        fakeForm += '<label for="' + this + '">' + titleCase + ' <input type="text" id="id_' + this + '" name="' + this + '" value="' + (initial[this] || '') + '" /></label>';
    });
    fakeForm += '<a class="inline-save" href="#" rel="' + $(addAnchor).attr("rel") + '">Save</a> <a class="inline-cancel" href="#">Cancel</a></li>';
    return fakeForm;
}

$(function () {
    $("a.submit").click(function () {
        $("form").submit();
    });

    $("#price-points a.add").click(function () {
        if (!$("#price-points li.form").length) {
            $("#price-points ul").append($(getForm(this)));
        } else {
            $("#price-points input:first").focus();
        }
        return false;
    });

    $("#extras a.add").click(function () {
        if (!$("#extras li.form").length) {
            $("#extras ul").append($(getForm(this)));
        } else {
            $("#extras input:first").focus();
        }
        return false;
    });


    $("a.inline-cancel").live("click", function () {
        $(this).parent().slideUp("fast", function () { $(this).remove(); });
        return false;
    });

    $("a.inline-save").live("click", function () {
        divId = $(this).closest("div").attr("id");
        trgt = this;
        action = $(trgt).attr("rel");
        params = $(this).parent().find(":input").serialize();
        $.post(action, params, function (data) {
            errors = data['errors'];
            if (errors) {
                $(trgt).parent().find(":input").each(function () {
                    if (errors[$(this).attr("name")]) {
                        $(this).addClass("error");
                        if (!$(this).next().hasClass("msg")) {
                            $(this).after('<span class="msg">' + errors[$(this).attr("name")][0] + '</span>');
                        }
                    } else {
                        $(this).removeClass("error");
                        $(this).parent().find('span.msg').remove();
                    }
                });
            } else {
                $(trgt).parent().replaceWith(data['new_row']);
                $("#" + divId + " li.empty").remove();
            }
        }, "json");
        return false;
    });

    $("a.edit").live("click", function () {
        trgt = this;
        addAnchor = $(this).closest("div").find("a.add");
        $.get($(this).attr("rel"), {}, function (data) {
            $(trgt).parent().replaceWith(getForm(addAnchor, data));
        }, "json");
        return false;
    });

    $("a.delete").live("click", function () {
        c = confirm('Are you sure you want to delete this item?  This action cannot be undone.');
        if (c) {
            trgt = this;
            action = $(this).attr("rel");
            $.post(action, $.param({delete: true}), function (data) {
                if (data['deleted']) {
                    $(trgt).slideUp("fast", function () { $(this).parent().remove(); });    
                } else {
                    $(trgt).insertAfter('<span class="fail">An error occurred.</span>');
                    $("span.fail").delay(1500).fadeOut("fast", function () { $(this).remove(); });
                }
            }, "json");
        }
        return false;
    });
});
</script>
{% endblock %}
