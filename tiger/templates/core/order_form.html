{% extends 'core/item_detail.html' %}

{% block form %}
<form id="orderForm" method="POST" action=".">
<span class="totalPrice">${{ total }}</span>
<span style="display:none;" class="originalPrice">${{ total }}</span>
<h3>Order now!</h3>
{% if form.non_field_errors %}
{{ form.non_field_errors }}
{% endif %}
{% if form.quantity.errors %}
{{ form.quantity.errors }}
{% endif %}
<label id="qty">
{{ form.quantity.label }}
{{ form.quantity }}
</label>
{% if form.variant %}
    {% if form.variant.errors %}
    {{ form.variant.errors }}
    {% endif %}
    {{ form.variant }}
{% endif %}
{% if form.upgrades %}
    <div class="upgrades">
    {% if form.upgrades.errors %}
    {{ form.upgrades.errors }}
    {% endif %}
    {{ form.upgrades }}
    </div>
{% endif %}
<label id="qty">
Special instructions ("No MSG", "Extra lettuce")
{{ form.notes }}
</label>
<input id="submit" type="submit" value="Add to order" />
<div class="clear"></div>
</form>
{% endblock %}

{% block js %}
<script type="text/javascript">
function getLabelNum(selector) {
    val = $(selector).parent().find('span').text();
    return Number(val);
}

function calculate() {
    qty = Number($("#id_quantity").val());
    basePrice = getLabelNum("[name='variant']:checked") || Number($("span.originalPrice").text().slice(1));
    upgrades = 0;
    $("[name='upgrades']:checked").each(function () {
        upgrades += getLabelNum(this);
    });
    total = (basePrice + upgrades) * qty;
    nonDecimalDigits = (Math.floor(total) + "").length;
    return total.toPrecision(nonDecimalDigits + 2);
}

$(function () {
    $("#orderForm :text,#orderForm :radio,#orderForm :checkbox").change(function () {
        $("span.totalPrice").text("$" + calculate());
    });
});
</script>
{% endblock %}
